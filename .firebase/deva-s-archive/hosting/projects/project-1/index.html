<!DOCTYPE html><html lang="en" class="antialiased break-words"> <head><!-- High Priority Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Running SQL on Dynamo DB through Athena | Deva&#39;s Archive</title><meta name="generator" content="Astro v5.1.1"><!-- Fonts --><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400..700&family=Newsreader:ital,opsz,wght@0,6..72,400..700;1,6..72,400..700&display=swap" rel="stylesheet"><!-- Low Priority Global Metadata --><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="RSS"><!-- Page Metadata --><link rel="canonical" href="https://example.com/projects/project-1/"><meta name="description" content="EcoBuddy is a mobile app that gamifies sustainable living. Users can set eco-friendly goals, track their carbon footprint, and earn virtual rewards for adopting environmentally conscious habits."><!-- Open Graph / Facebook --><meta property="og:type" content="article"><meta property="og:url" content="https://example.com/projects/project-1/"><meta property="og:title" content="Running SQL on Dynamo DB through Athena | Deva's Archive"><meta property="og:description" content="EcoBuddy is a mobile app that gamifies sustainable living. Users can set eco-friendly goals, track their carbon footprint, and earn virtual rewards for adopting environmentally conscious habits."><meta property="og:image" content="https://example.com/athena-sql.png"><meta property="og:image:alt" content="Project preview"><!-- X/Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://example.com/projects/project-1/"><meta property="twitter:title" content="Running SQL on Dynamo DB through Athena | Deva's Archive"><meta property="twitter:description" content="EcoBuddy is a mobile app that gamifies sustainable living. Users can set eco-friendly goals, track their carbon footprint, and earn virtual rewards for adopting environmentally conscious habits."><meta property="twitter:image" content="https://example.com/athena-sql.png"><meta name="twitter:image:alt" content="Project preview"><script type="module">localStorage.theme==="dark"&&document.documentElement.classList.add("dark");</script><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script type="module" src="/_astro/ClientRouter.astro_astro_type_script_index_0_lang.BScVxmeO.js"></script><link rel="stylesheet" href="/_astro/_slug_.CKQGQ27y.css">
<style>[data-astro-image]{width:100%;height:auto;-o-object-fit:var(--fit);object-fit:var(--fit);-o-object-position:var(--pos);object-position:var(--pos);aspect-ratio:var(--w) / var(--h)}[data-astro-image=responsive]{max-width:calc(var(--w) * 1px);max-height:calc(var(--h) * 1px)}[data-astro-image=fixed]{width:calc(var(--w) * 1px);height:calc(var(--h) * 1px)}
</style></head> <body class="bg-main text-main"> <div class="flex flex-col min-h-screen px-4 md:px-8"> <nav class="min-h-10 pt-4 pb-12 relative sm:min-h-14 sm:pb-24 md:pt-8" data-astro-cid-dmqpwcec> <div class="w-full max-w-3xl mx-auto relative" data-astro-cid-dmqpwcec> <button class="menu-toggle w-8 h-8 -ml-1 flex items-center justify-center relative z-30 md:hidden" aria-label="Open Menu" aria-expanded="false" aria-controls="menu-items" data-astro-cid-dmqpwcec> <span class="menu-toggle-icon w-6 h-px relative bg-current" data-astro-cid-dmqpwcec></span> </button> <ul id="menu-items" class="menu flex gap-6" data-astro-cid-dmqpwcec> <li class="py-1" data-astro-cid-dmqpwcec> <a class="text-xl font-serif text-main hover:underline hover:underline-offset-2 hover:decoration-1 md:text-base" href="/" data-astro-cid-dmqpwcec="true"> Home </a> </li><li class="py-1" data-astro-cid-dmqpwcec> <a class="text-xl font-serif text-main hover:underline hover:underline-offset-2 hover:decoration-1 md:text-base" href="/projects" data-astro-cid-dmqpwcec="true"> Projects </a> </li><li class="py-1" data-astro-cid-dmqpwcec> <a class="text-xl font-serif text-main hover:underline hover:underline-offset-2 hover:decoration-1 md:text-base" href="/blog" data-astro-cid-dmqpwcec="true"> Blog </a> </li><li class="py-1" data-astro-cid-dmqpwcec> <a class="text-xl font-serif text-main hover:underline hover:underline-offset-2 hover:decoration-1 md:text-base" href="/tags" data-astro-cid-dmqpwcec="true"> Tags </a> </li> </ul> </div> <div class="absolute right-0 top-4 z-10 md:top-8" data-astro-cid-dmqpwcec> <button id="theme-toggle" class="w-8 h-8 -mr-2 flex items-center justify-center" aria-label="Change color scheme"> <svg class="w-4 h-4 fill-current" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"> <circle cx="8" cy="8" r="8"></circle> </svg> </button> <script type="module">document.addEventListener("astro:after-swap",()=>{localStorage.theme==="dark"&&document.documentElement.classList.add("dark")});</script> <script type="module">document.addEventListener("astro:page-load",()=>{const e=typeof localStorage<"u"&&localStorage.getItem("theme")?localStorage.getItem("theme")||"light":window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";e==="light"?document.documentElement.classList.remove("dark"):document.documentElement.classList.add("dark"),window.localStorage.setItem("theme",e);const o=()=>{const t=document.documentElement;t.classList.toggle("dark");const a=t.classList.contains("dark");localStorage.setItem("theme",a?"dark":"light")};document.getElementById("theme-toggle")?.addEventListener("click",o)});</script> </div> </nav>  <script type="module">function n(){const s=document.querySelector(".menu"),e=document.querySelector(".menu-toggle");e?.addEventListener("click",()=>{const t=e.getAttribute("aria-expanded")==="true";e.classList.toggle("is-active"),e.setAttribute("aria-expanded",t?"false":"true"),e.setAttribute("aria-label",t?"Open Menu":"Close Menu"),s?.classList.toggle("is-visible")})}n();document.addEventListener("astro:after-swap",n);</script>  <main class="grow w-full max-w-3xl mx-auto">  <article class="mb-16 sm:mb-24"> <header class="mb-8"> <h1 class="text-3xl leading-tight font-serif font-medium sm:text-5xl sm:leading-tight">Running SQL on Dynamo DB through Athena</h1> </header> <div class="max-w-none prose prose-dante sm:prose-lg"> <h2 id="introduction">Introduction</h2>
<p>Athena is a service that allows you to run SQL queries on different data sources like Amazon S3. However Athena doesn’t support Dynamo DB as a data source. In order to circumvent this issue, we will use some of the glue services and store data in parquet format in S3.</p>
<p><img src="/athena-sql.png" alt="athena-sql.png"></p>
<h2 id="dynamo-dbcrawler">Dynamo DB Crawler</h2>
<p>A glue crawler is a tool to populate a Glue Data Catalog. An AWS glue data catalog is a database that can have multiple tables. Each table can have the schema or index of where and how data is stored in a particular data source. This data can be populated using a glue crawler.</p>
<ol>
<li>Configure a glue data catalog</li>
</ol>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>CrawlerDatabase:</span></span>
<span class="line"><span>    Type: AWS::Glue::Database</span></span>
<span class="line"><span>    Properties:</span></span>
<span class="line"><span>      CatalogId: !Ref AWS::AccountId</span></span>
<span class="line"><span>      DatabaseInput:</span></span>
<span class="line"><span>        Name: DynamoDBCrawler</span></span>
<span class="line"><span>        Description: Database for crawler</span></span></code></pre>
<p>The <code>DatabaseInput</code> field is to will be where the dynamo db schema will be stored. <code>CatalogId</code> is the AWS account id.</p>
<ol start="2">
<li>Configure a Crawler for Dynamo DB</li>
</ol>
<p>The role required can make use of <code>AWSGlueServiceRole</code> Managed Policy Arn with <code>glue.amazonaws.com</code> as principal. Other Permissions related to Dynamo DB include -</p>
<ul>
<li>GetItem</li>
<li>Scan</li>
<li>DescribeTable</li>
<li>Query</li>
</ul>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>DynamoDBCrawler:</span></span>
<span class="line"><span>    Type: AWS::Glue::Crawler</span></span>
<span class="line"><span>    Properties:</span></span>
<span class="line"><span>      Name: dynamoDBCrawler</span></span>
<span class="line"><span>      DatabaseName: // Name of glue data catalog database</span></span>
<span class="line"><span>      Role: // Role with Dynamo DB and Glue Service Role</span></span>
<span class="line"><span>      Targets:</span></span>
<span class="line"><span>        DynamoDBTargets:</span></span>
<span class="line"><span>          - Path: // Enter name of Dynamo Database</span></span></code></pre>
<p>Defining the target of a crawler tells it which data source to crawl. On running, this will create a table with the same name as that of Dynamo DB.</p>
<h2 id="glue-job-to-update-data-in-parquetformat">Glue Job to update Data in parquet format</h2>
<p>To deploy a glue job, it is imperative to write a python script to tell it what to do. Refer here : <a href="https://docs.aws.amazon.com/glue/latest/dg/aws-glue-programming-intro-tutorial.html">AWS Glue Tutorial</a>
Basically it can have three nodes. One dynamic node referencing data catalog database with the name of Dynamo Db. A second node to apply mapping. A third node to write it in parquet format. Learn more about parquet format here: <a href="https://www.snowflake.com/guides/what-parquet#:~:text=Parquet%20is%20an%20open%20source,wide%20variety%20of%20encoding%20types">Parquet</a>..
This python script needs to be stored in a S3 bucket. This can be done through AWS console or as I prefer it using AWS CLI.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>aws s3 cp filename.txt s3://bucket-name</span></span></code></pre>
<p>After uploading the script to the bucket, you can reference it in the Glue Job like,</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>GlueJob:</span></span>
<span class="line"><span>    Type: AWS::Glue::Job</span></span>
<span class="line"><span>    Properties:</span></span>
<span class="line"><span>      Name: // Job Name</span></span>
<span class="line"><span>      GlueVersion: '3.0'</span></span>
<span class="line"><span>      Command:</span></span>
<span class="line"><span>        Name: glueetl</span></span>
<span class="line"><span>        ScriptLocation: s3://script-location-glue/script.py</span></span>
<span class="line"><span>      Role: // Role with S3 Read and write access and glue service role</span></span></code></pre>
<p>The Role should have a <code>AWSGlueServiceRole</code> and S3 Read and Write Access.</p>
<h2 id="s3-crawler">S3 Crawler</h2>
<p>Once the Job is complete, we can use a crawler to define the schema in glue data catalog table. This table can be part of the same data catalog Database defined above for the dynamo db.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span> S3Crawler:</span></span>
<span class="line"><span>    Type: AWS::Glue::Crawler</span></span>
<span class="line"><span>    Properties:</span></span>
<span class="line"><span>      Name: s3Crawler</span></span>
<span class="line"><span>      DatabaseName: // Name of glue data catalog database</span></span>
<span class="line"><span>      Role: // Role with Glue Service role and S3 access</span></span>
<span class="line"><span>      Targets:</span></span>
<span class="line"><span>        S3Targets:</span></span>
<span class="line"><span>          - Path: // Name of S3 bucket</span></span></code></pre>
<h2 id="step-functions-to-run-it-all">Step Functions to run it all</h2>
<p>Using Glue Jobs with step functions is pretty straightforward. AWS Step Functions will wait for the Glue Job to complete when you add ‘.sync’ to Resource section.</p>
<p><img src="/athena-ddb-step-fn.png" alt="athena-ddb-step-fn.png"></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>RunGlueJob:</span></span>
<span class="line"><span>  Type: Task</span></span>
<span class="line"><span>  Parameters:</span></span>
<span class="line"><span>    JobName: !Ref GlueJob</span></span>
<span class="line"><span>  Resource: arn:aws:states:::glue:startJobRun.sync</span></span>
<span class="line"><span>  Next: UploadDataInParquetFormat</span></span></code></pre>
<p>However Running crawlers is not as straightforward. It will require adding a get crawler request and using a choice state to check whether the crawler is running or not. And crawler tasks are run through aws-sdk.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>arn:aws:states:::aws-sdk:glue:getCrawler</span></span></code></pre>
<p>The Choice state can check for the variable $.Crawler.State for READY to see if the crawler has stopped running. Adding a wait and can help reduce unnecessary requests.
After a workflow execution, you are good to run queries after selecting the name of the S3 bucket from the Athena console. Or you can use aws-sdk for Athena to run queries.</p> </div> </article>  </main> <footer class="w-full max-w-3xl mx-auto pt-12 pb-10 sm:pt-24 sm:pb-14"> <div class="mb-4 flex flex-wrap gap-x-6 gap-y-1"> <a class="font-serif hover:underline hover:underline-offset-2" href="/contact"> Contact </a><a class="font-serif hover:underline hover:underline-offset-2" href="/terms"> Terms </a> </div> <div class="pt-6 flex flex-col gap-4 border-t border-dashed border-main sm:flex-row-reverse sm:justify-between sm:items-center"> <div class="flex flex-wrap gap-x-4 gap-y-1"> <a class="inline-flex items-center justify-center text-sm hover:underline hover:underline-offset-2" href="https://www.instagram.com/d.e.v.a_p/" target="_blank" rel="noopener noreferer"> Instagram </a><a class="inline-flex items-center justify-center text-sm hover:underline hover:underline-offset-2" href="https://www.linkedin.com/in/deva-pramod-3200bb216?lipi=urn%3Ali%3Apage%3Ad_flagship3_profile_view_base_contact_details%3ByYj6tkxTQreYl4qI4lplrA%3D%3D" target="_blank" rel="noopener noreferer"> LinkedIn </a> </div> <p class="text-sm">
&copy; 2025&nbsp;<a class="hover:underline hover:underline-offset-2" href="/">Deva&#39;s Archive</a>. All rights reserved.
</p> </div> </footer> </div> </body></html>